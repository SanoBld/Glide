<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NEON HOCKEY</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME SYSTEM - Auto Light/Dark Mode
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  /* Light theme (default) */
  --bg: #f8f9fa;
  --bg-secondary: #ffffff;
  --surface: #ffffff;
  --surface-elevated: #ffffff;
  --border: #e0e4e8;
  --border-hover: #cbd2d9;
  --text-primary: #1a1d1f;
  --text-secondary: #6f7782;
  --text-tertiary: #9ba1a8;
  
  /* Accent colors */
  --accent-primary: #2563eb;
  --accent-primary-hover: #1d4ed8;
  --accent-secondary: #8b5cf6;
  --team0: #ef4444;
  --team1: #3b82f6;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  
  /* Effects */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
  
  /* Game specific */
  --puck-color: #06b6d4;
  --puck-glow: rgba(6, 182, 212, 0.3);
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f1419;
    --bg-secondary: #161b22;
    --surface: #1c2128;
    --surface-elevated: #22272e;
    --border: #2d333b;
    --border-hover: #444c56;
    --text-primary: #e6edf3;
    --text-secondary: #8b949e;
    --text-tertiary: #6e7681;
    
    --accent-primary: #3b82f6;
    --accent-primary-hover: #2563eb;
    --accent-secondary: #a78bfa;
    --team0: #f87171;
    --team1: #60a5fa;
    --success: #34d399;
    --warning: #fbbf24;
    --danger: #f87171;
    
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
    --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
    
    --puck-glow: rgba(6, 182, 212, 0.5);
  }
}

/* Manual theme override */
html[data-theme="light"] {
  --bg: #f8f9fa;
  --bg-secondary: #ffffff;
  --surface: #ffffff;
  --surface-elevated: #ffffff;
  --border: #e0e4e8;
  --border-hover: #cbd2d9;
  --text-primary: #1a1d1f;
  --text-secondary: #6f7782;
  --text-tertiary: #9ba1a8;
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
  --puck-glow: rgba(6, 182, 212, 0.3);
}

html[data-theme="dark"] {
  --bg: #0f1419;
  --bg-secondary: #161b22;
  --surface: #1c2128;
  --surface-elevated: #22272e;
  --border: #2d333b;
  --border-hover: #444c56;
  --text-primary: #e6edf3;
  --text-secondary: #8b949e;
  --text-tertiary: #6e7681;
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
  --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.6);
  --puck-glow: rgba(6, 182, 212, 0.5);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BASE STYLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: var(--bg);
  color: var(--text-primary);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  touch-action: none;
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME TOGGLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#theme-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
  background: var(--surface);
  border: 1px solid var(--border);
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.2rem;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow-sm);
}

#theme-toggle:hover {
  border-color: var(--border-hover);
  transform: scale(1.05) rotate(15deg);
  box-shadow: var(--shadow-md);
}

#theme-toggle:active {
  transform: scale(0.95);
}

#theme-toggle.hidden {
  opacity: 0;
  pointer-events: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERFORMANCE TOGGLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#perf-toggle {
  position: fixed;
  top: 74px;
  right: 20px;
  z-index: 1000;
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 8px 12px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-size: 0.8125rem;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: var(--shadow-sm);
}

#perf-toggle:hover {
  border-color: var(--accent-primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

#perf-toggle.active {
  background: var(--success);
  border-color: var(--success);
  color: white;
}

#perf-toggle.hidden {
  opacity: 0;
  pointer-events: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  background: var(--bg);
  transition: opacity 0.3s ease;
  padding: 20px;
}

.screen.hidden {
  opacity: 0;
  pointer-events: none;
}

#screen-game {
  z-index: 1;
  background: var(--bg);
}

#screen-game.hidden {
  display: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 32px 28px;
  width: 90%;
  max-width: 420px;
  box-shadow: var(--shadow-lg);
  animation: fadeUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}

@keyframes fadeUp {
  from {
    transform: translateY(20px) scale(0.97);
    opacity: 0;
  }
  to {
    transform: none;
    opacity: 1;
  }
}

.logo {
  font-family: 'Inter', sans-serif;
  font-size: 2rem;
  font-weight: 800;
  letter-spacing: -0.02em;
  color: var(--accent-primary);
  text-align: center;
  line-height: 1;
  margin-bottom: 8px;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

.tagline {
  text-align: center;
  color: var(--text-secondary);
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 24px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
label {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
  display: block;
}

input, select {
  width: 100%;
  padding: 12px 16px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface-elevated);
  color: var(--text-primary);
  font-family: 'Inter', sans-serif;
  font-size: 0.9375rem;
  outline: none;
  transition: all 0.2s ease;
}

input:focus, select:focus {
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  transform: translateY(-1px);
}

select option {
  background: var(--surface);
  color: var(--text-primary);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  width: 100%;
  padding: 14px;
  border-radius: 10px;
  border: none;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  font-size: 0.9375rem;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn:hover::before {
  width: 300px;
  height: 300px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn:active {
  transform: scale(0.98);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn-primary {
  background: var(--accent-primary);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: var(--accent-primary-hover);
}

.btn-secondary {
  background: var(--accent-secondary);
  color: white;
}

.btn-ghost {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-primary);
}

.btn-ghost:hover {
  border-color: var(--accent-primary);
  color: var(--accent-primary);
  background: rgba(37, 99, 235, 0.05);
}

.btn-success {
  background: var(--success);
  color: white;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLOR PICKER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.color-grid {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
  margin: 8px 0;
}

.c-dot {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.c-dot:hover {
  transform: scale(1.1) rotate(5deg);
}

.c-dot.sel {
  border-color: var(--text-primary);
  transform: scale(1.15);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
  animation: bounce 0.6s ease;
}

@keyframes bounce {
  0%, 100% { transform: scale(1.15); }
  50% { transform: scale(1.25); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DIVIDER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.divider {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 8px 0;
  color: var(--text-tertiary);
  font-size: 0.875rem;
  font-weight: 500;
}

.divider::before, .divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM LAYOUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.row {
  display: flex;
  gap: 12px;
}

.row > .field {
  flex: 1;
}

.field {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.gap-sm { gap: 8px; }
.gap-md { gap: 16px; }
.gap-lg { gap: 24px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CODE DISPLAY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.code-box {
  background: var(--surface-elevated);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.code-box:hover {
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  transform: scale(1.02);
}

.code-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 2.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  color: var(--accent-primary);
  animation: glow 2s ease-in-out infinite;
}

@keyframes glow {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.code-hint {
  font-size: 0.8125rem;
  color: var(--text-secondary);
  margin-top: 8px;
  font-weight: 500;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLAYER LIST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.player-list {
  background: var(--surface-elevated);
  border-radius: 10px;
  padding: 12px;
  max-height: 120px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.player-item {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.9375rem;
  padding: 8px;
  border-radius: 6px;
  transition: all 0.2s ease;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(-20px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.player-item:hover {
  background: var(--surface);
  transform: translateX(4px);
}

.player-color {
  width: 14px;
  height: 14px;
  border-radius: 4px;
  flex-shrink: 0;
  animation: pulse-color 2s ease-in-out infinite;
}

@keyframes pulse-color {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODE SELECTION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mode-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin: 8px 0;
}

.mode-card {
  background: var(--surface-elevated);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 16px 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-align: center;
}

.mode-card:hover {
  border-color: var(--accent-primary);
  background: rgba(37, 99, 235, 0.05);
  transform: translateY(-4px);
}

.mode-card.sel {
  border-color: var(--accent-primary);
  background: rgba(37, 99, 235, 0.1);
  transform: scale(1.05);
}

.mode-icon {
  font-size: 1.75rem;
  display: block;
  margin-bottom: 8px;
  animation: wiggle 1s ease-in-out infinite;
}

@keyframes wiggle {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(-5deg); }
  75% { transform: rotate(5deg); }
}

.mode-name {
  font-weight: 700;
  font-size: 0.9375rem;
  margin-bottom: 4px;
}

.mode-desc {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HUD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#hud {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 50;
  display: none;
  align-items: stretch;
  justify-content: space-between;
  padding: 16px 20px;
  pointer-events: none;
  gap: 12px;
  background: linear-gradient(to bottom, var(--bg) 0%, transparent 100%);
}

.hud-team {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 80px;
  background: var(--surface);
  border-radius: 12px;
  padding: 12px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.hud-score {
  font-family: 'JetBrains Mono', monospace;
  font-size: 2rem;
  font-weight: 700;
  line-height: 1;
}

.hud-name {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  color: var(--text-secondary);
  margin-top: 4px;
  letter-spacing: 0.05em;
}

.hud-center {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  background: var(--surface);
  border-radius: 12px;
  padding: 12px 20px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  animation: fadeIn 0.5s ease 0.1s backwards;
}

.hud-mode {
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-secondary);
}

.hud-timer {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--warning);
}

.hud-ping {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  padding: 4px 10px;
  background: var(--surface-elevated);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.ping-good { color: var(--success); }
.ping-ok { color: var(--warning); }
.ping-bad { color: var(--danger); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--surface);
  backdrop-filter: blur(12px);
  padding: 12px 24px;
  border-radius: 12px;
  font-size: 0.9375rem;
  font-weight: 600;
  border: 1px solid var(--border);
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 200;
  white-space: nowrap;
  box-shadow: var(--shadow-lg);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#chat-bar {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 8px;
  z-index: 60;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  flex-wrap: wrap;
  max-width: 90%;
  justify-content: center;
}

#chat-bar.show {
  opacity: 1;
  pointer-events: auto;
}

.chat-btn {
  background: var(--surface);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border);
  padding: 10px 16px;
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 0.875rem;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s ease;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
  box-shadow: var(--shadow-sm);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    transform: translateY(20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.chat-btn:hover {
  border-color: var(--accent-primary);
  color: var(--accent-primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

#chat-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 70;
  background: var(--surface);
  border: 1px solid var(--border);
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.25rem;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow-md);
}

#chat-toggle:hover {
  border-color: var(--accent-primary);
  transform: scale(1.1) rotate(15deg);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOAL OVERLAY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#goal-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 80;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s ease;
  background: radial-gradient(circle, rgba(0,0,0,0.3) 0%, transparent 70%);
}

.goal-text {
  font-family: 'Inter', sans-serif;
  font-size: 4rem;
  font-weight: 800;
  letter-spacing: 0.05em;
  text-shadow: 0 0 40px currentColor, 0 4px 20px rgba(0,0,0,0.3);
  transform: scale(0.5);
  transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1.5);
}

#goal-overlay.show {
  opacity: 1;
}

#goal-overlay.show .goal-text {
  transform: scale(1);
  animation: goalPulse 0.5s ease;
}

@keyframes goalPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POWERUP POPUP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pu-popup {
  position: fixed;
  pointer-events: none;
  font-family: 'Inter', sans-serif;
  font-size: 0.875rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  z-index: 75;
  opacity: 0;
  transition: opacity 0.3s ease;
  text-shadow: 0 0 10px currentColor, 0 2px 8px rgba(0,0,0,0.3);
  white-space: nowrap;
  background: var(--surface);
  padding: 8px 16px;
  border-radius: 10px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-lg);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENDGAME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#endgame {
  position: fixed;
  inset: 0;
  z-index: 90;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(8px);
}

.endgame-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 40px 32px;
  text-align: center;
  max-width: 400px;
  width: 90%;
  box-shadow: var(--shadow-xl);
  animation: fadeUp 0.4s ease;
}

.win-title {
  font-family: 'Inter', sans-serif;
  font-size: 1.75rem;
  font-weight: 800;
  margin-bottom: 12px;
}

.win-score {
  font-family: 'JetBrains Mono', monospace;
  font-size: 3rem;
  font-weight: 700;
  margin: 16px 0;
  letter-spacing: 0.1em;
  color: var(--accent-primary);
}

.win-lb {
  background: var(--surface-elevated);
  border-radius: 12px;
  padding: 16px;
  margin: 20px 0;
  text-align: left;
}

.lb-title {
  font-size: 0.8125rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-secondary);
  margin-bottom: 12px;
}

.lb-row {
  display: flex;
  justify-content: space-between;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9375rem;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}

.lb-row:last-child {
  border: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI DIFFICULTY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.diff-row {
  display: flex;
  gap: 8px;
  margin: 8px 0;
}

.diff-btn {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: 2px solid var(--border);
  background: transparent;
  color: var(--text-primary);
  cursor: pointer;
  font-family: 'Inter', sans-serif;
  font-weight: 700;
  font-size: 0.875rem;
  text-transform: uppercase;
  transition: all 0.2s ease;
}

.diff-btn.sel {
  background: var(--accent-secondary);
  border-color: var(--accent-secondary);
  color: white;
  transform: scale(1.05);
}

.diff-btn:hover:not(.sel) {
  border-color: var(--accent-secondary);
  background: rgba(139, 92, 246, 0.1);
  transform: translateY(-2px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPECTATOR BANNER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#spec-banner {
  position: fixed;
  top: 90px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent-secondary);
  color: white;
  padding: 6px 18px;
  border-radius: 10px;
  font-size: 0.8125rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  z-index: 60;
  display: none;
  box-shadow: var(--shadow-md);
  animation: fadeIn 0.5s ease;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCROLLBAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
  transition: background 0.2s;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--border-hover);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CANVAS & GAME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game-wrap {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.shake {
  animation: shake 0.25s ease;
}

@keyframes shake {
  0%, 100% { transform: none; }
  15% { transform: translate(-8px, -5px) rotate(-1deg); }
  30% { transform: translate(7px, 6px) rotate(1deg); }
  45% { transform: translate(-5px, 3px) rotate(-0.5deg); }
  60% { transform: translate(4px, -4px) rotate(0.5deg); }
  75% { transform: translate(-3px, 2px); }
  90% { transform: translate(2px, -2px); }
}

canvas {
  border-radius: 16px;
  display: block;
  box-shadow: var(--shadow-xl);
  max-width: 100%;
  max-height: 100%;
  border: 1px solid var(--border);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITY CLASSES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hidden {
  display: none !important;
}

.text-center { text-align: center; }
.text-small { font-size: 0.875rem; }
.text-muted { color: var(--text-secondary); }
.font-mono { font-family: 'JetBrains Mono', monospace; }
.font-bold { font-weight: 700; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 480px) {
  .card {
    padding: 24px 20px;
  }
  
  .logo {
    font-size: 1.75rem;
  }
  
  .mode-grid {
    grid-template-columns: 1fr;
  }
  
  .chat-btn {
    font-size: 0.8125rem;
    padding: 8px 12px;
  }
  
  .hud-score {
    font-size: 1.5rem;
  }
  
  .goal-text {
    font-size: 3rem;
  }
}
</style>
</head>
<body>

<!-- THEME TOGGLE -->
<div id="theme-toggle" onclick="ThemeManager.toggle()" title="Changer le thÃ¨me">
  <span id="theme-icon">ğŸŒ™</span>
</div>

<!-- PERFORMANCE TOGGLE -->
<div id="perf-toggle" onclick="Performance.toggle()" title="Mode Performance">
  âš¡ Performance
</div>

<!-- HUD -->
<div id="hud">
  <div class="hud-team" id="hud-t1">
    <div class="hud-score" style="color:var(--team1)" id="sc-t1">0</div>
    <div class="hud-name" id="nm-t1">TEAM â–²</div>
  </div>
  <div class="hud-center">
    <div class="hud-mode" id="hud-mode-label">CLASSIQUE</div>
    <div class="hud-timer" id="hud-timer" style="display:none">1:30</div>
    <div class="hud-ping" id="hud-ping" style="display:none">-- ms</div>
  </div>
  <div class="hud-team" id="hud-t0">
    <div class="hud-score" style="color:var(--team0)" id="sc-t0">0</div>
    <div class="hud-name" id="nm-t0">TEAM â–¼</div>
  </div>
</div>

<!-- SPECTATOR BANNER -->
<div id="spec-banner">ğŸ‘ MODE SPECTATEUR</div>

<!-- GOAL OVERLAY -->
<div id="goal-overlay">
  <div class="goal-text" id="goal-text">BUT !</div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- CHAT -->
<div id="chat-toggle" onclick="ChatSystem.toggle()">ğŸ’¬</div>
<div id="chat-bar">
  <button class="chat-btn" onclick="ChatSystem.send(0)">ğŸ‘ Bien jouÃ© !</button>
  <button class="chat-btn" onclick="ChatSystem.send(1)">ğŸ˜… DÃ©solÃ© !</button>
  <button class="chat-btn" onclick="ChatSystem.send(2)">ğŸ”¥ Rematch !</button>
  <button class="chat-btn" onclick="ChatSystem.send(3)">ğŸ¤ GG !</button>
  <button class="chat-btn" onclick="ChatSystem.send(4)">ğŸ˜¤ Lag !</button>
  <button class="chat-btn" onclick="ChatSystem.send(5)">ğŸ’ Let's go !</button>
</div>

<!-- SCREENS -->
<!-- HOME -->
<div class="screen" id="screen-home">
  <div class="card" style="display:flex;flex-direction:column;gap:16px">
    <div>
      <div class="logo">NEON HOCKEY</div>
      <div class="tagline">âš¡ P2P Â· Real-time Â· Multiplayer</div>
    </div>
    <div class="field">
      <label>Votre nom</label>
      <input type="text" id="inp-name" value="Joueur" maxlength="10" placeholder="Nomâ€¦">
    </div>
    <div class="field">
      <label>Couleur</label>
      <div class="color-grid" id="color-grid"></div>
    </div>
    <button class="btn btn-primary" onclick="UI.goCreate()">ğŸ® CrÃ©er une partie</button>
    <button class="btn btn-ghost" onclick="UI.goJoin()">ğŸ”— Rejoindre</button>
    <div class="divider">ou</div>
    <button class="btn btn-secondary" onclick="UI.goAI()">ğŸ¤– Jouer contre l'IA</button>
    <button class="btn btn-ghost" style="font-size:0.875rem;padding:10px" onclick="UI.goLeaderboard()">ğŸ† Tableau des scores</button>
  </div>
</div>

<!-- CREATE -->
<div class="screen hidden" id="screen-create">
  <div class="card" style="display:flex;flex-direction:column;gap:16px">
    <h2 style="font-size:1.5rem;font-weight:800;color:var(--accent-primary)">Nouvelle Partie</h2>
    <div class="field">
      <label>Taille des Ã©quipes</label>
      <select id="sel-team">
        <option value="1">1 vs 1 â€” Duel</option>
        <option value="2">2 vs 2 â€” Ã‰quipe</option>
        <option value="3">3 vs 3 â€” Brigade</option>
      </select>
    </div>
    <div class="field">
      <label>Mode de jeu</label>
      <div class="mode-grid" id="mode-grid"></div>
    </div>
    <button class="btn btn-primary" onclick="Host.init()">âš¡ GÃ©nÃ©rer le salon</button>
    <button class="btn btn-ghost" onclick="UI.goHome()">â† Retour</button>
  </div>
</div>

<!-- LOBBY -->
<div class="screen hidden" id="screen-lobby">
  <div class="card" style="display:flex;flex-direction:column;gap:16px">
    <h2 style="font-size:1.25rem;font-weight:800;color:var(--accent-primary)">Salon d'attente</h2>
    <div class="code-box" onclick="UI.copyCode()">
      <div class="code-value" id="lobby-code">------</div>
      <div class="code-hint">ğŸ“‹ Touchez pour copier le code</div>
    </div>
    <div class="player-list" id="lobby-players"></div>
    <button class="btn btn-primary" id="btn-start" onclick="Host.startGame()" disabled>â³ En attente de joueursâ€¦</button>
    <button class="btn btn-ghost" onclick="location.reload()">âœ• Annuler</button>
  </div>
</div>

<!-- JOIN -->
<div class="screen hidden" id="screen-join">
  <div class="card" style="display:flex;flex-direction:column;gap:16px">
    <h2 style="font-size:1.5rem;font-weight:800;color:var(--accent-primary)">Rejoindre</h2>
    <div class="field">
      <label>Code de la partie</label>
      <input type="text" id="join-code" placeholder="EX: A7B2K9" maxlength="6" style="text-transform:uppercase;font-size:1.5rem;letter-spacing:0.2em;text-align:center;font-family:'JetBrains Mono',monospace">
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary" style="flex:3" onclick="Client.init(false)">ğŸ”— Connexion</button>
      <button class="btn btn-ghost" style="flex:1.5;font-size:0.875rem" onclick="Client.init(true)">ğŸ‘ Spectateur</button>
    </div>
    <div class="player-list" id="join-players" style="display:none"></div>
    <button class="btn btn-ghost" onclick="UI.goHome()">â† Retour</button>
    <p id="join-status" style="font-size:0.875rem;text-align:center;color:var(--accent-primary)"></p>
  </div>
</div>

<!-- AI SETUP -->
<div class="screen hidden" id="screen-ai">
  <div class="card" style="display:flex;flex-direction:column;gap:16px">
    <h2 style="font-size:1.5rem;font-weight:800;color:var(--accent-secondary)">ğŸ¤– vs IA</h2>
    <div class="field">
      <label>Mode de jeu</label>
      <div class="mode-grid" id="mode-grid-ai"></div>
    </div>
    <div class="field">
      <label>DifficultÃ© IA</label>
      <div class="diff-row" id="diff-row">
        <button class="diff-btn" data-d="0" onclick="UI.selDiff(0)">Facile</button>
        <button class="diff-btn sel" data-d="1" onclick="UI.selDiff(1)">Moyen</button>
        <button class="diff-btn" data-d="2" onclick="UI.selDiff(2)">IA++</button>
      </div>
    </div>
    <button class="btn btn-secondary" onclick="AIGame.start()">ğŸ® Jouer !</button>
    <button class="btn btn-ghost" onclick="UI.goHome()">â† Retour</button>
  </div>
</div>

<!-- LEADERBOARD -->
<div class="screen hidden" id="screen-lb">
  <div class="card" style="display:flex;flex-direction:column;gap:16px;max-width:400px">
    <h2 style="font-size:1.5rem;font-weight:800;color:var(--warning)">ğŸ† Leaderboard Local</h2>
    <div id="lb-content" style="min-height:80px"></div>
    <button class="btn btn-ghost" style="font-size:0.875rem" onclick="Leaderboard.reset()">ğŸ—‘ RÃ©initialiser</button>
    <button class="btn btn-ghost" onclick="UI.goHome()">â† Retour</button>
  </div>
</div>

<!-- ENDGAME -->
<div id="endgame" class="hidden">
  <div class="endgame-card">
    <div class="win-title" id="eg-title">Victoire !</div>
    <div class="win-score" id="eg-score">5 â€” 3</div>
    <div class="win-lb">
      <div class="lb-title">Leaderboard</div>
      <div id="eg-lb"></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px;margin-top:8px">
      <button class="btn btn-primary" onclick="location.reload()">ğŸ”„ Rejouer</button>
      <button class="btn btn-ghost" onclick="UI.goHome();document.getElementById('endgame').classList.add('hidden')">â† Menu</button>
    </div>
  </div>
</div>

<!-- GAME -->
<div class="screen hidden" id="screen-game">
  <div id="game-wrap">
    <canvas id="canvas"></canvas>
  </div>
</div>

<script>
/* ===========================================================
   NEON HOCKEY â€” Full Engine (Fixed & Enhanced)
   =========================================================== */

// â”€â”€ PERFORMANCE MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Performance = {
  enabled: false,
  toggle() {
    this.enabled = !this.enabled;
    localStorage.setItem('neonhockey_perf', this.enabled);
    document.getElementById('perf-toggle').classList.toggle('active', this.enabled);
    Effects.toast(this.enabled ? 'âš¡ Mode Performance activÃ©' : 'ğŸ¨ Mode Normal activÃ©');
  },
  init() {
    this.enabled = localStorage.getItem('neonhockey_perf') === 'true';
    if(this.enabled) {
      document.getElementById('perf-toggle').classList.add('active');
    }
  }
};

// â”€â”€ THEME MANAGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ThemeManager = {
  current: 'auto',
  init() {
    const saved = localStorage.getItem('neonhockey_theme') || 'auto';
    this.set(saved);
  },
  toggle() {
    const themes = ['auto', 'light', 'dark'];
    const idx = themes.indexOf(this.current);
    const next = themes[(idx + 1) % themes.length];
    this.set(next);
  },
  set(theme) {
    this.current = theme;
    localStorage.setItem('neonhockey_theme', theme);
    
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme');
    } else {
      document.documentElement.setAttribute('data-theme', theme);
    }
    
    this.updateIcon();
  },
  updateIcon() {
    const icon = document.getElementById('theme-icon');
    if (this.current === 'light') {
      icon.textContent = 'â˜€ï¸';
    } else if (this.current === 'dark') {
      icon.textContent = 'ğŸŒ™';
    } else {
      icon.textContent = 'ğŸ’«';
    }
  },
  hideToggle() {
    document.getElementById('theme-toggle').classList.add('hidden');
    document.getElementById('perf-toggle').classList.add('hidden');
  },
  showToggle() {
    document.getElementById('theme-toggle').classList.remove('hidden');
    document.getElementById('perf-toggle').classList.remove('hidden');
  }
};

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const C = {
  W: 480, H: 820,
  PUCK_R: 17,
  PAD_R: 33,
  FRICTION: 1, 
  BASE_MAX_SPEED: 35, 
  GOAL_W_RATIO: 0.40,
  SUBSTEPS: 10, 
  COLORS: ['#ef4444','#3b82f6','#10b981','#f59e0b','#f97316','#a78bfa','#06b6d4','#ffffff'],
  COLOR_NAMES: ['Rouge','Bleu','Vert','Jaune','Orange','Violet','Cyan','Blanc'],
  MODES: [
    {id:'classic', icon:'ğŸ’', name:'Classique', desc:'Premier Ã  7 buts', pts:7, timed:false, pups:false, speedMult:1},
    {id:'arcade',  icon:'âš¡', name:'Arcade',    desc:'Power-ups Â· 5 buts', pts:5, timed:false, pups:true, speedMult:1.1},
    {id:'speed',   icon:'ğŸš€', name:'Vitesse',   desc:'Super rapide Â· 5 buts', pts:5, timed:false, pups:false, speedMult:1.8},
    {id:'sudden',  icon:'ğŸ’€', name:'Mort Subite',desc:'1 seul but gagne', pts:1, timed:false, pups:false, speedMult:1.2},
    {id:'timed',   icon:'â±', name:'Chrono',    desc:'2 minutes Â· Max buts', pts:999, timed:true, timerDur:120, pups:false, speedMult:1.1},
    {id:'chaos',   icon:'ğŸŒ€', name:'Chaos',     desc:'Power-ups Â· Portails', pts:7, timed:false, pups:true, speedMult:1.4, portals:true},
  ],
  AI_DIFFS: [
    {name:'Facile',   speed:.35, pred:.18, err:70, react:.15},
    {name:'Moyen',    speed:.60, pred:.40, err:35, react:.35},
    {name:'IA++',     speed:.95, pred:.80, err:8, react:.75},
  ],
  QUICK_CHATS: ['ğŸ‘ Bien jouÃ© !','ğŸ˜… DÃ©solÃ© !','ğŸ”¥ Rematch !','ğŸ¤ GG !','ğŸ˜¤ Lag !','ğŸ’ Let\'s go !'],
  PUPS_TYPES: ['big_pad','mini_puck','speed_boost','freeze','ghost'],
};

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let S = {
  myColor: C.COLORS[0],
  myName: 'Joueur',
  myMode: 'classic',
  aiDiff: 1,
  role: null,
  myTeam: 0,
  myIdx: 0,
  started: false,
};

// â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Leaderboard = {
  key: 'neonhockey_lb',
  get() { 
    try { 
      return JSON.parse(localStorage.getItem(this.key)) || {}; 
    } catch(e) {
      return {};
    } 
  },
  addWin(name) {
    const d = this.get(); 
    d[name] = (d[name]||0)+1;
    localStorage.setItem(this.key, JSON.stringify(d));
  },
  reset() {
    if(confirm('Effacer le leaderboard ?')) { 
      localStorage.removeItem(this.key); 
      UI.goLeaderboard(); 
    }
  },
  render(el) {
    const d = this.get();
    const arr = Object.entries(d).sort((a,b)=>b[1]-a[1]);
    if(!arr.length) { 
      el.innerHTML='<div style="color:var(--text-secondary);font-size:0.9375rem;text-align:center;padding:12px">Aucune victoire enregistrÃ©e</div>'; 
      return; 
    }
    el.innerHTML = arr.slice(0,8).map((r,i)=>`
      <div class="lb-row">
        <span>${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||`#${i+1}`} ${r[0]}</span>
        <span style="color:var(--accent-primary)">${r[1]} victoire${r[1]>1?'s':''}</span>
      </div>`).join('');
  }
};

// â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Particles = {
  pool: [],
  spawn(x, y, color, n=20, type='burst') {
    if(Performance.enabled && n > 10) n = Math.floor(n / 2);
    for(let i=0;i<n;i++){
      const angle = Math.random()*Math.PI*2;
      const spd = type==='burst'? 3+Math.random()*8 : 1+Math.random()*3;
      this.pool.push({
        x,y,vx:Math.cos(angle)*spd,vy:Math.sin(angle)*spd,
        life:1, decay:0.025+Math.random()*.02,
        color, size: type==='burst'? 3+Math.random()*5 : 2+Math.random()*3,
        type
      });
    }
  },
  update(){
    this.pool = this.pool.filter(p=>{
      p.x+=p.vx; p.y+=p.vy;
      p.vx*=0.93; p.vy*=0.93; p.vy+=0.12;
      p.life-=p.decay;
      return p.life>0;
    });
  },
  draw(ctx){
    if(Performance.enabled) return;
    this.pool.forEach(p=>{
      ctx.globalAlpha = p.life*p.life;
      ctx.fillStyle = p.color;
      ctx.shadowColor = p.color; ctx.shadowBlur = 8;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);
      ctx.fill();
    });
    ctx.globalAlpha=1; ctx.shadowBlur=0;
  }
};

// â”€â”€ PUCK TRAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Trail = {
  hist: [],
  max: 16, // AugmentÃ© pour plus de traÃ®nÃ©e
  push(x,y){ this.hist.push({x,y}); if(this.hist.length>this.max) this.hist.shift(); },
  draw(ctx){
    if(Performance.enabled) return;
    this.hist.forEach((p,i)=>{
      const t = i/this.hist.length;
      ctx.globalAlpha = t*t*0.5;
      const r = C.PUCK_R * (.25 + t*.75);
      ctx.fillStyle = '#06b6d4';
      ctx.shadowColor = '#06b6d4'; ctx.shadowBlur = 12;
      ctx.beginPath(); ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fill();
    });
    ctx.globalAlpha=1; ctx.shadowBlur=0;
  },
  reset(){ this.hist=[]; }
};

// â”€â”€ PHYSICS ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Physics = {
  step(game, dt) {
    const pk = game.puck;
    const maxSpd = C.BASE_MAX_SPEED * game.modeConfig.speedMult * (game.pups.mini_puck>0?1.25:1);
    const GW = C.W * C.GOAL_W_RATIO;
    const GS = (C.W-GW)/2, GE = GS+GW;

    const subDt = dt / C.SUBSTEPS;
    for(let s=0;s<C.SUBSTEPS;s++){
      pk.x += pk.vx * subDt;
      pk.y += pk.vy * subDt;
      pk.vx *= Math.pow(C.FRICTION, subDt);
      pk.vy *= Math.pow(C.FRICTION, subDt);

      const pr = C.PUCK_R * (game.pups.mini_puck>0 ? 0.55 : 1);

      if(pk.x < pr){ pk.x = pr; pk.vx = Math.abs(pk.vx)*0.85; }
      if(pk.x > C.W-pr){ pk.x = C.W-pr; pk.vx = -Math.abs(pk.vx)*0.85; }

      if(pk.y < pr){
        if(pk.x > GS && pk.x < GE){ game.scoreGoal(0); return; }
        else { pk.y = pr; pk.vy = Math.abs(pk.vy)*0.85; Particles.spawn(pk.x,pr,'#3b82f6',5,'wall'); }
      }
      if(pk.y > C.H-pr){
        if(pk.x > GS && pk.x < GE){ game.scoreGoal(1); return; }
        else { pk.y = C.H-pr; pk.vy = -Math.abs(pk.vy)*0.85; Particles.spawn(pk.x,C.H-pr,'#ef4444',5,'wall'); }
      }

      if(game.portals && game.portals.length > 0){
        game.portals.forEach(port=>{
          const d = Math.hypot(pk.x-port.x, pk.y-port.y);
          if(d < 25+pr){
            const other = game.portals.find(p2=>p2!==port);
            if(other){ 
              pk.x=other.x; 
              pk.y=other.y; 
              Particles.spawn(other.x,other.y,'#a78bfa',15); 
            }
          }
        });
      }

      const v = Math.hypot(pk.vx,pk.vy);
      if(v > maxSpd){ pk.vx=(pk.vx/v)*maxSpd; pk.vy=(pk.vy/v)*maxSpd; }
    }

    game.players.forEach(pl => {
      if (pl.frozen > 0) { pl.frozen -= dt; return; }
      
      const pr = C.PUCK_R * (game.pups.mini_puck > 0 ? 0.55 : 1);
      const padR = C.PAD_R * (pl.big > 0 ? 1.9 : 1);
      const minD = pr + padR;
      const dx = pk.x - pl.x, dy = pk.y - pl.y;
      const dist = Math.hypot(dx, dy);

      if (dist < minD && dist > 0) {
        const nx = dx / dist, ny = dy / dist;

        // 1. Positionnement correct pour Ã©viter le "collage"
        pk.x = pl.x + nx * (minD + 0.5);
        pk.y = pl.y + ny * (minD + 0.5);

        // 2. Calcul de la vitesse relative
        // On utilise pl.vx et pl.vy qui sont les vitesses rÃ©elles du joueur
        const rvx = pk.vx - (pl.vx || 0);
        const rvy = pk.vy - (pl.vy || 0);
        const velAlongNormal = rvx * nx + rvy * ny;

        // Si le palet s'Ã©loigne dÃ©jÃ , on ignore
        if (velAlongNormal > 0) return;

        // 3. Rebond et transfert de force
        // Restitution 1.0 = rebond parfait. 1.2 = effet "punchy"
        const rest = 1.2; 
        let impulse = -(1 + rest) * velAlongNormal;
        
        pk.vx += impulse * nx;
        pk.vy += impulse * ny;

        // 4. Ajout d'un effet de "friction latÃ©rale" (pour donner de l'effet au palet)
        pk.vx += (pl.vx || 0) * 0.3;
        pk.vy += (pl.vy || 0) * 0.3;

        // 5. Limitation fluide de la vitesse
        const curSpd = Math.hypot(pk.vx, pk.vy);
        if (curSpd > maxSpd) {
          pk.vx = (pk.vx / curSpd) * maxSpd;
          pk.vy = (pk.vy / curSpd) * maxSpd;
        }

        // Effets visuels basÃ©s sur la force rÃ©elle de l'impact
        const hitStr = Math.abs(velAlongNormal);
        if (hitStr > 5) {
          Effects.shake(Math.min(2, hitStr / 10));
          Particles.spawn(pk.x, pk.y, '#06b6d4', 12);
        }
      }
    });
  }
};

// â”€â”€ EFFECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Effects = {
  shake(lvl=1){
    if(Performance.enabled) return;
    const w = document.getElementById('game-wrap');
    w.classList.remove('shake');
    void w.offsetWidth;
    w.classList.add('shake');
  },
  goalFlash(team){
    const ov = document.getElementById('goal-overlay');
    const txt = document.getElementById('goal-text');
    txt.style.color = team===0 ? 'var(--team0)' : 'var(--team1)';
    txt.textContent = 'âš¡ BUT !';
    ov.classList.add('show');
    setTimeout(()=>ov.classList.remove('show'), 1800);
    this.shake(2);
  },
  toast(msg, dur=2000){
    const t = document.getElementById('toast');
    t.textContent = msg; t.style.opacity=1;
    clearTimeout(t._t);
    t._t = setTimeout(()=>t.style.opacity=0, dur);
  },
  puPopup(text, color, x, y){
    const d = document.createElement('div');
    d.className='pu-popup'; d.textContent=text; d.style.color=color;
    document.body.appendChild(d);
    const cvs = document.getElementById('canvas');
    const rect = cvs.getBoundingClientRect();
    const sc = rect.width/C.W;
    d.style.left = (rect.left + x*sc - 50)+'px';
    d.style.top = (rect.top + y*sc - 30)+'px';
    d.style.opacity=1;
    setTimeout(()=>{d.style.opacity=0;setTimeout(()=>d.remove(),400)},1200);
  }
};

// â”€â”€ POWER-UPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PupDefs = {
  big_pad:    {icon:'ğŸ”¥',label:'MEGA PADDLE !',color:'#f97316',dur:6000},
  mini_puck:  {icon:'ğŸ¯',label:'MINI PUCK !',  color:'#f59e0b',dur:6000},
  speed_boost:{icon:'ğŸ’¨',label:'TURBO !',       color:'#06b6d4',dur:5000},
  freeze:     {icon:'â„ï¸', label:'FREEZE !',      color:'#60a5fa',dur:3000},
  ghost:      {icon:'ğŸ‘»',label:'GHOST !',        color:'#a78bfa',dur:4000},
};

const PupSystem = {
  list:[],
  spawnTimer:0,
  INTERVAL:10000, // RÃ©duit pour plus de power-ups
  update(game, now){
    if(now - this.spawnTimer > this.INTERVAL){
      this.spawnTimer = now;
      this.spawn(game);
    }
    this.list = this.list.filter(p=>now < p.exp);
    game.players.forEach(pl=>{
      this.list.forEach((pu,i)=>{
        const d = Math.hypot(pl.x-pu.x, pl.y-pu.y);
        if(d < C.PAD_R + 18){
          this.apply(pu.type, pl, game, now);
          this.list.splice(i,1);
        }
      });
    });
  },
  spawn(game){
    const y = C.H*0.25 + Math.random()*C.H*0.5;
    const x = 70 + Math.random()*(C.W-140);
    const type = C.PUPS_TYPES[Math.floor(Math.random()*C.PUPS_TYPES.length)];
    this.list.push({x,y,type,exp:Date.now()+12000,born:Date.now()});
  },
  apply(type, pl, game, now){
    const def = PupDefs[type];
    Effects.puPopup(def.icon+' '+def.label, def.color, pl.x, pl.y);
    Particles.spawn(pl.x,pl.y,def.color,20);
    switch(type){
      case 'big_pad': pl.big = def.dur; break;
      case 'mini_puck': game.pups.mini_puck = def.dur; break;
      case 'speed_boost': pl.speedBoost = def.dur; break;
      case 'freeze':
        game.players.forEach(p=>{ if(p.team !== pl.team) p.frozen = def.dur; });
        break;
      case 'ghost': pl.ghost = def.dur; break;
    }
  },
  draw(ctx, now){
    this.list.forEach(pu=>{
      const age = now - pu.born;
      const t = age/12000;
      const alpha = t > 0.75 ? (1-t)*4 : 1;
      const pulse = 1 + Math.sin(age/180)*0.2;
      ctx.globalAlpha = alpha;
      ctx.shadowColor = PupDefs[pu.type].color;
      ctx.shadowBlur = Performance.enabled ? 0 : 20*pulse;
      ctx.font = `${30*pulse}px Arial`;
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(PupDefs[pu.type].icon, pu.x, pu.y);
    });
    ctx.globalAlpha=1; ctx.shadowBlur=0;
  }
};

// â”€â”€ AI SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AI = {
  diff: 1,
  lastTargetX: C.W/2,
  lastTargetY: 80,
  update(game){
    const cfg = C.AI_DIFFS[this.diff];
    const pl = game.players.find(p=>p.id==='AI');
    if(!pl) return;
    const pk = game.puck;
    
    let tx, ty;
    
    // Si le palet vient vers l'IA (dÃ©fense)
    if(pk.vy < 0 && pk.y < C.H*0.6) {
      // PrÃ©diction amÃ©liorÃ©e
      const timeToReach = (pk.y - 100) / Math.abs(pk.vy);
      tx = pk.x + pk.vx * timeToReach * cfg.pred;
      // Ajouter erreur humaine
      tx += (Math.random()-0.5)*cfg.err;
      // Rester dans les limites
      tx = Math.max(C.PAD_R*2, Math.min(C.W-C.PAD_R*2, tx));
      ty = 90 + Math.random()*25;
    } 
    // Sinon position d'attente stratÃ©gique
    else {
      // L'IA se positionne en fonction de oÃ¹ est le palet
      const targetZone = pk.x;
      tx = targetZone;
      // Varier la profondeur selon la difficultÃ©
      ty = 90 + (Math.random() * 60) + (cfg.react * 100);
    }
    
    // Smooth movement vers la cible
    this.lastTargetX += (tx - this.lastTargetX) * cfg.react;
    this.lastTargetY += (ty - this.lastTargetY) * cfg.react;
    
    const spd = (C.PAD_R*2.5) * cfg.speed;
    const dx = this.lastTargetX - pl.x, dy = this.lastTargetY - pl.y;
    const d = Math.hypot(dx,dy);
    if(d>1){
      pl.x += (dx/d)*Math.min(d,spd);
      pl.y += (dy/d)*Math.min(d,spd);
    }
    
    const r = C.PAD_R * (pl.big>0 ? 1.9 : 1);
    pl.x = Math.max(r, Math.min(C.W-r, pl.x));
    pl.y = Math.max(r, Math.min(C.H/2-r, pl.y));
  }
};

// â”€â”€ GAME ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Game = {
  active: false,
  puck: {x:0,y:0,vx:0,vy:0},
  players: [],
  score: {t0:0,t1:0},
  modeConfig: C.MODES[0],
  pups: {mini_puck:0},
  portals: null,
  timeLeft: 90,
  _scoreBlocked: false,
  _slowScale: 1,
  _slowTimer: 0,

  setup(modeId, connections, aiMode=false){
    this.active=true;
    this.modeConfig = C.MODES.find(m=>m.id===modeId)||C.MODES[0];
    this.players=[]; this.score={t0:0,t1:0}; this.pups={mini_puck:0};
    this.timeLeft=this.modeConfig.timerDur || 90; 
    this._scoreBlocked=false; this._slowScale=1;
    Trail.reset();

    // Portails en mode chaos
    if(this.modeConfig.portals){
      this.portals=[
        {x:90,  y:C.H*0.35},
        {x:C.W-90, y:C.H*0.65}
      ];
    } else {
      this.portals=null;
    }

    PupSystem.list=[]; 
    PupSystem.spawnTimer=Date.now();

    this.players.push({
      id:'HOST',
      x:C.W/2,
      y:C.H-90,
      team:0,
      color:S.myColor,
      name:S.myName,
      big:0,
      frozen:0,
      ghost:0,
      speedBoost:0
    });

    if(aiMode){
      this.players.push({
        id:'AI',
        x:C.W/2,
        y:90,
        team:1,
        color:'#3b82f6',
        name:`IA (${C.AI_DIFFS[AI.diff].name})`,
        big:0,
        frozen:0,
        ghost:0,
        speedBoost:0
      });
    } else {
      connections.forEach((conn,i)=>{
        const team=(i+1)%2;
        const startY=team===0?C.H-90:90;
        this.players.push({
          id:conn.peer,
          conn,
          x:C.W/2+(Math.random()*40-20),
          y:startY,
          team,
          color:conn.metadata?.color||'#888',
          name:conn.metadata?.name||'Guest',
          big:0,
          frozen:0,
          ghost:0,
          speedBoost:0
        });
      });
    }

    this.resetPuck();
    this.updateHUD();
  },

  resetPuck(){
    this._scoreBlocked=false;
    this.puck={x:C.W/2,y:C.H/2,vx:0,vy:0};
    Trail.reset();
    setTimeout(()=>{
      const angle = (Math.PI/4) + (Math.random()*(Math.PI/2));
      const spd = 6 * this.modeConfig.speedMult;
      this.puck.vx = Math.cos(angle)*spd * (Math.random()>.5?1:-1);
      this.puck.vy = Math.sin(angle)*spd * (Math.random()>.5?1:-1);
    }, 600);
  },

  update(dt, now){
    if(!this.active || this._scoreBlocked) return;

    if(this._slowTimer > 0){
      this._slowTimer -= dt * 16;
      if(this._slowTimer <= 0){ this._slowScale=1; this._slowTimer=0; }
    }
    const edt = dt * this._slowScale;

    if(this.modeConfig.timed){
      this.timeLeft -= edt/60;
      if(this.timeLeft <= 0){ this.timeLeft=0; this.endGame(); return; }
      const min=Math.floor(this.timeLeft/60), sec=Math.floor(this.timeLeft%60);
      document.getElementById('hud-timer').textContent = `${min}:${sec.toString().padStart(2,'0')}`;
    }

    this.players.forEach(pl=>{
      if(pl.big>0) pl.big -= edt*16;
      if(pl.frozen>0) pl.frozen -= edt*16;
      if(pl.ghost>0) pl.ghost -= edt*16;
      if(pl.speedBoost>0) pl.speedBoost -= edt*16;
    });
    if(this.pups.mini_puck>0) this.pups.mini_puck -= edt*16;

    if(this.modeConfig.pups) PupSystem.update(this,now);

    Physics.step(this, edt);
    Trail.push(this.puck.x, this.puck.y);
    if(S.role==='ai') AI.update(this);
  },

  scoreGoal(teamScorer){
    if(this._scoreBlocked) return;
    this._scoreBlocked=true;
    if(teamScorer===0) this.score.t0++;
    else this.score.t1++;

    this._slowScale = 0.08; this._slowTimer = 60;
    Effects.goalFlash(teamScorer);
    Particles.spawn(this.puck.x, this.puck.y,
      teamScorer===0?'#ef4444':'#3b82f6', 40, 'burst');
    this.updateHUD();

    const targetScore = this.modeConfig.pts;
    if(this.score.t0>=targetScore || this.score.t1>=targetScore){
      setTimeout(()=>this.endGame(),1600);
    } else {
      setTimeout(()=>this.resetPuck(),1800);
    }

    if(S.role==='host') Host.broadcast({t:'GOAL',s:this.score,team:teamScorer});
  },

  movePlayer(idx, x, y){
    const pl = this.players[idx];
    if(!pl || pl.frozen>0) return;
    const r = C.PAD_R * (pl.big>0?1.9:1);
    const maxSpeed = 20 * (pl.speedBoost>0 ? 1.6 : 1);
    const dx = x - pl.x, dy = y - pl.y;
    const d = Math.hypot(dx,dy);
    const cappedD = Math.min(d, maxSpeed);
    if(d>0){ pl.x += (dx/d)*cappedD; pl.y += (dy/d)*cappedD; }
    pl.x = Math.max(r, Math.min(C.W-r, pl.x));
    pl.y = Math.max(r, Math.min(C.H-r, pl.y));
    if(pl.team===0) pl.y = Math.max(C.H/2+r, pl.y);
    else pl.y = Math.min(C.H/2-r, pl.y);
  },

  updateHUD(){
    document.getElementById('sc-t0').textContent = this.score.t0;
    document.getElementById('sc-t1').textContent = this.score.t1;
    const t0pl = this.players.find(p=>p.team===0);
    const t1pl = this.players.find(p=>p.team===1);
    document.getElementById('nm-t0').textContent = (t0pl?.name||'TEAM')+'  â–¼';
    document.getElementById('nm-t1').textContent = 'â–²  '+(t1pl?.name||'TEAM');
  },

  endGame(){
    this.active=false;
    if(S.role==='host') Host.broadcast({t:'ENDGAME',s:this.score});
    const myWon = (S.myTeam===0 && this.score.t0>this.score.t1)||
                  (S.myTeam===1 && this.score.t1>this.score.t0);
    if(myWon && S.role !== 'spectator') Leaderboard.addWin(S.myName);

    document.getElementById('eg-title').textContent = myWon ? 'ğŸ† Victoire !' : 'ğŸ˜” DÃ©faiteâ€¦';
    document.getElementById('eg-title').style.color = myWon ? 'var(--accent-primary)' : 'var(--text-secondary)';
    document.getElementById('eg-score').textContent = `${this.score.t0} â€” ${this.score.t1}`;
    Leaderboard.render(document.getElementById('eg-lb'));
    document.getElementById('endgame').classList.remove('hidden');
  }
};

// â”€â”€ RENDERER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Render = {
  cvs: document.getElementById('canvas'),
  ctx: document.getElementById('canvas').getContext('2d'),
  sc: 1,
  teamView: 0,
  lastData: null,

  init(teamView){
    this.teamView=teamView;
    this.resize();
    window.addEventListener('resize',()=>this.resize());
    this._setupInput();
  },

  resize(){
    const asp = C.W/C.H;
    const ww = window.innerWidth, wh = window.innerHeight;
    let fw, fh;
    if(ww/wh < asp){ fw=ww*.97; fh=fw/asp; }
    else { fh=wh*.97; fw=fh*asp; }
    this.cvs.width=C.W; this.cvs.height=C.H;
    this.cvs.style.width=fw+'px'; this.cvs.style.height=fh+'px';
    this.sc = fw/C.W;
  },

  _setupInput(){
    const send = (cx,cy) => {
      const rect = this.cvs.getBoundingClientRect();
      let rx=(cx-rect.left)/this.sc;
      let ry=(cy-rect.top)/this.sc;
      if(this.teamView===1){ rx=C.W-rx; ry=C.H-ry; }
      if(S.role==='host'||S.role==='ai') Game.movePlayer(S.myIdx, rx, ry);
      else if(S.role==='client'&&Client.conn) Client.conn.send({t:'I',x:rx,y:ry,ts:Date.now()});
    };
    const h = e=>{ 
      if(S.role === 'spectator') return;
      e.preventDefault(); 
      const t=e.touches?e.touches[0]:e; 
      send(t.clientX,t.clientY); 
    };
    this.cvs.addEventListener('mousemove',h);
    this.cvs.addEventListener('touchmove',h,{passive:false});
    this.cvs.addEventListener('touchstart',h,{passive:false});
  },

  sync(data){
    this.lastData=data;
    document.getElementById('sc-t0').textContent=data.s.t0;
    document.getElementById('sc-t1').textContent=data.s.t1;
  },

  draw(now){
    const ctx=this.ctx;
    const d = (S.role==='host'||S.role==='ai') ? {pk:Game.puck,pl:Game.players} : this.lastData;
    if(!d) return;

    ctx.clearRect(0,0,C.W,C.H);

    ctx.save();
    if(this.teamView===1){ ctx.translate(C.W,C.H); ctx.rotate(Math.PI); }

    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches || 
                   document.documentElement.getAttribute('data-theme') === 'dark';
    const bgColor = isDark ? '#0a0e14' : '#f1f5f9';
    const gridColor = isDark ? 'rgba(255,255,255,.015)' : 'rgba(0,0,0,.015)';
    const lineColor = isDark ? 'rgba(255,255,255,.08)' : 'rgba(0,0,0,.08)';

    ctx.fillStyle=bgColor;
    ctx.fillRect(0,0,C.W,C.H);

    if(!Performance.enabled) {
      ctx.strokeStyle=gridColor; ctx.lineWidth=1;
      for(let x=0;x<C.W;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,C.H); ctx.stroke(); }
      for(let y=0;y<C.H;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(C.W,y); ctx.stroke(); }
    }

    const GW=C.W*C.GOAL_W_RATIO, GS=(C.W-GW)/2;
    ctx.fillStyle='rgba(59,130,246,.12)'; ctx.fillRect(GS,0,GW,18);
    ctx.fillStyle='rgba(239,68,68,.12)'; ctx.fillRect(GS,C.H-18,GW,18);
    ctx.strokeStyle='rgba(59,130,246,.6)'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(GS,2); ctx.lineTo(GS+GW,2); ctx.stroke();
    ctx.strokeStyle='rgba(239,68,68,.6)';
    ctx.beginPath(); ctx.moveTo(GS,C.H-2); ctx.lineTo(GS+GW,C.H-2); ctx.stroke();

    ctx.strokeStyle=lineColor; ctx.lineWidth=3;
    ctx.setLineDash([15,10]);
    ctx.beginPath(); ctx.moveTo(0,C.H/2); ctx.lineTo(C.W,C.H/2); ctx.stroke();
    ctx.setLineDash([]);

    ctx.strokeStyle=lineColor; ctx.lineWidth=3;
    ctx.beginPath(); ctx.arc(C.W/2,C.H/2,72,0,Math.PI*2); ctx.stroke();

    if(Game.portals && Game.portals.length > 0){
      Game.portals.forEach(p=>{
        const t=Date.now()/800;
        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(t);
        const g=ctx.createRadialGradient(0,0,2,0,0,32);
        g.addColorStop(0,'rgba(167,139,250,.95)'); g.addColorStop(1,'rgba(167,139,250,0)');
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,32,0,Math.PI*2); ctx.fill();
        ctx.restore();
        if(!Performance.enabled) {
          ctx.strokeStyle='rgba(167,139,250,.8)'; ctx.lineWidth=2.5;
          ctx.beginPath(); ctx.arc(p.x,p.y,30,0,Math.PI*2); ctx.stroke();
        }
        ctx.font='1.4rem Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillStyle='#a78bfa'; ctx.fillText('ğŸŒ€',p.x,p.y);
      });
    }

    if(S.role==='host'||S.role==='ai'){
      PupSystem.draw(ctx, now);
    } else if(d.pups && d.pups.length) {
      d.pups.forEach(pu=>{
        const age = now - pu.born;
        const t = age/12000;
        const alpha = t > 0.75 ? (1-t)*4 : 1;
        const pulse = 1 + Math.sin(age/180)*0.2;
        ctx.globalAlpha = Math.max(0, Math.min(1, alpha));
        ctx.shadowColor = PupDefs[pu.type]?.color||'#fff'; 
        ctx.shadowBlur = Performance.enabled ? 0 : 20*pulse;
        ctx.font=`${30*pulse}px Arial`; 
        ctx.textAlign='center'; 
        ctx.textBaseline='middle';
        ctx.fillText(PupDefs[pu.type]?.icon||'âœ¨', pu.x, pu.y);
      });
      ctx.globalAlpha=1; ctx.shadowBlur=0;
    }

    Trail.draw(ctx);

    if(S.role==='client'||S.role==='spectator'){ Trail.push(d.pk.x, d.pk.y); }

    const pk = d.pk;
    const pr = C.PUCK_R * (d.puckScale || (Game.pups?.mini_puck>0 ? 0.55 : 1));
    const pgrd = ctx.createRadialGradient(pk.x,pk.y,0,pk.x,pk.y,pr);
    pgrd.addColorStop(0,'#ffffff'); 
    pgrd.addColorStop(0.4,'#e0f2fe'); 
    pgrd.addColorStop(1,'#06b6d4');
    ctx.fillStyle=pgrd;
    ctx.shadowColor='#06b6d4'; 
    ctx.shadowBlur = Performance.enabled ? 15 : 25;
    ctx.beginPath(); ctx.arc(pk.x,pk.y,pr,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;

    d.pl.forEach(p=>{
      const r = C.PAD_R * (p.big>0 ? 1.9 : 1);
      ctx.globalAlpha = p.ghost>0 ? 0.45 : 1;
      ctx.shadowColor=p.color; 
      ctx.shadowBlur = Performance.enabled ? 10 : 22*(p.big>0?1.5:1);
      const pgr=ctx.createRadialGradient(p.x,p.y-r*.2,r*.1,p.x,p.y,r);
      pgr.addColorStop(0,'#fff'); 
      pgr.addColorStop(0.35,p.color);
      const darken = c=>c+'bb';
      pgr.addColorStop(1,darken(p.color));
      ctx.fillStyle=pgr;
      ctx.beginPath(); ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='rgba(255,255,255,.4)'; ctx.lineWidth=3;
      ctx.stroke();
      if(p.frozen>0){
        ctx.strokeStyle='rgba(96,165,250,.85)'; ctx.lineWidth=5;
        ctx.beginPath(); ctx.arc(p.x,p.y,r+5,0,Math.PI*2); ctx.stroke();
      }
      ctx.shadowBlur=0; ctx.globalAlpha=1;
      ctx.fillStyle='rgba(255,255,255,.9)';
      ctx.font=`bold ${13}px 'Inter',sans-serif`;
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText((p.name||'').charAt(0).toUpperCase(), p.x, p.y);
    });

    Particles.draw(ctx);
    ctx.restore();
  }
};

// â”€â”€ NETWORK â€” HOST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Host = {
  conns: [], peer: null,
  _pings: {},

  init(){
    const id = Math.random().toString(36).substr(2,6).toUpperCase();
    Host.peer = new Peer(id);
    Host.peer.on('open', pid=>{
      S.role='host'; S.myIdx=0; S.myTeam=0;
      UI.showLobby(pid);
      Host._updateLobby();
      const modeSize = parseInt(document.getElementById('sel-team').value)*2;
      if(modeSize <= 2){
        document.getElementById('btn-start').disabled=false;
        document.getElementById('btn-start').textContent='âš¡ LANCER !';
      }
    });
    Host.peer.on('connection', conn=>{
      conn.on('open',()=>{
        Host.conns.push(conn);
        Host._updateLobby();
        Host.broadcastLobby();
        Effects.toast(`${conn.metadata?.name||'Joueur'} a rejoint !`);
        const modeSize = parseInt(document.getElementById('sel-team').value)*2;
        if(Host.conns.length+1 >= modeSize){
          document.getElementById('btn-start').disabled=false;
          document.getElementById('btn-start').textContent='âš¡ LANCER !';
        }
        conn.on('data',d=>{
          if(d.t==='I'){
            const idx=Host.conns.indexOf(conn)+1;
            Game.movePlayer(idx,d.x,d.y);
          }
          if(d.t==='CHAT'){
            Effects.toast((conn.metadata?.name||'Guest')+': '+d.msg,3000);
            Host.broadcast({t:'CHAT',from:conn.metadata?.name||'Guest',msg:d.msg});
          }
          if(d.t==='PONG') {
            const rtt = Date.now() - (Host._pings[conn.peer]||Date.now());
            conn._ping = rtt;
          }
        });
        conn.on('close',()=>{
          Host.conns=Host.conns.filter(c=>c!==conn);
          Host._updateLobby();
          Host.broadcastLobby();
        });
      });
    });
    Host.peer.on('error',err=>{ 
      if(err.type==='unavailable-id') Host.init(); 
      else Effects.toast('Erreur: '+err.type); 
    });
  },

  _updateLobby(){
    const list = document.getElementById('lobby-players');
    list.innerHTML=`<div class="player-item"><div class="player-color" style="background:${S.myColor}"></div><b>${S.myName}</b> (HÃ´te)</div>`
      + Host.conns.map(c=>`<div class="player-item"><div class="player-color" style="background:${c.metadata?.color||'#888'}"></div>${c.metadata?.name||'Guest'}</div>`).join('');
  },

  broadcastLobby(){
    const players = [{name:S.myName, color:S.myColor, host:true}].concat(
      Host.conns.map(c=>({name:c.metadata?.name||'Guest', color:c.metadata?.color||'#888', host:false}))
    );
    Host.broadcast({t:'LOBBY',players});
  },

  startGame(){
    const modeId = document.querySelector('#mode-grid .sel')?.dataset.mode || 'classic';
    const teamSize = parseInt(document.getElementById('sel-team').value);

    if(teamSize === 1 && Host.conns.length === 0){
      S.role='ai'; S.aiDiff=1; S.myIdx=0; S.myTeam=0;
      AI.diff=1;
      Game.setup(modeId, [], true);
      UI.showGame(); 
      document.getElementById('hud').style.display='flex';
      document.getElementById('hud-mode-label').textContent = Game.modeConfig.name.toUpperCase();
      if(Game.modeConfig.timed) document.getElementById('hud-timer').style.display='block';
      ThemeManager.hideToggle();
      Render.init(0); 
      Loop.start();
      return;
    }

    Game.setup(modeId, Host.conns);
    Host.conns.forEach((c,i)=>{
      const clientTeam=(i+1)%2;
      c.send({t:'START',me:clientTeam,idx:i+1,modeId,w:C.W,h:C.H});
    });
    UI.showGame();
    document.getElementById('hud').style.display='flex';
    document.getElementById('hud-mode-label').textContent = Game.modeConfig.name.toUpperCase();
    if(Game.modeConfig.timed) document.getElementById('hud-timer').style.display='block';
    ThemeManager.hideToggle();
    Render.init(0); 
    Loop.start();
    setInterval(()=>{ 
      Host._pings={};
      Host.conns.forEach(c=>{ Host._pings[c.peer]=Date.now(); c.send({t:'PING',ts:Date.now()}); });
    },3000);
  },

  broadcast(msg){
    Host.conns.forEach(c=>{ try{c.send(msg)}catch(e){} });
  }
};

// â”€â”€ NETWORK â€” CLIENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Client = {
  conn: null, peer: null, spectator: false,
  _pingTs: 0,

  init(spectator=false){
    this.spectator=spectator;
    const code=document.getElementById('join-code').value.toUpperCase().trim();
    if(code.length<4){ Effects.toast('Code invalide'); return; }
    Client.peer = new Peer(undefined);
    Client.peer.on('open',()=>{
      const conn=Client.peer.connect(code,{metadata:{color:S.myColor,name:S.myName}});
      Client.conn=conn;
      conn.on('open',()=>{
        UI.setJoinStatus(spectator?'ğŸ‘ ConnectÃ© en spectateurâ€¦':'âœ… ConnectÃ© ! En attente du dÃ©marrageâ€¦');
        document.getElementById('join-players').style.display='block';
      });
      conn.on('data',d=>{
        if(d.t==='LOBBY'){
          const list = document.getElementById('join-players');
          list.innerHTML = d.players.map(p=>`
            <div class="player-item">
              <div class="player-color" style="background:${p.color}"></div>
              ${p.name} ${p.host?'(HÃ´te)':''}
            </div>`).join('');
        }
        if(d.t==='START'){
          S.role=spectator?'spectator':'client';
          S.myTeam=d.me; S.myIdx=d.idx;
          Client._modeId = d.modeId;
          const mCfg = C.MODES.find(m=>m.id===d.modeId)||C.MODES[0];
          document.getElementById('hud-mode-label').textContent = mCfg.name.toUpperCase();
          if(mCfg.timed) document.getElementById('hud-timer').style.display='block';
          document.getElementById('spec-banner').style.display=spectator?'block':'none';
          UI.showGame(); 
          Render.init(d.me);
          document.getElementById('hud').style.display='flex';
          ThemeManager.hideToggle();
          Loop.start();
        }
        if(d.t==='U'){
          Render.sync(d);
          if(d.pl) Render.lastData=d;
          if(d.timeLeft!==undefined){
            const min=Math.floor(d.timeLeft/60), sec=Math.floor(d.timeLeft%60);
            document.getElementById('hud-timer').textContent=`${min}:${sec.toString().padStart(2,'0')}`;
          }
          if(d.names){ 
            document.getElementById('nm-t0').textContent=(d.names.t0||'TEAM')+'  â–¼'; 
            document.getElementById('nm-t1').textContent='â–²  '+(d.names.t1||'TEAM'); 
          }
        }
        if(d.t==='GOAL'){ 
          Effects.goalFlash(d.team||0); 
          Effects.shake(2);
          if(d.s){ 
            document.getElementById('sc-t0').textContent=d.s.t0; 
            document.getElementById('sc-t1').textContent=d.s.t1; 
          }
        }
        if(d.t==='ENDGAME'){
          const myWon=(S.myTeam===0&&d.s.t0>d.s.t1)||(S.myTeam===1&&d.s.t1>d.s.t0);
          if(myWon && !spectator) Leaderboard.addWin(S.myName);
          document.getElementById('eg-title').textContent=myWon?'ğŸ† Victoire !':'ğŸ˜” DÃ©faiteâ€¦';
          document.getElementById('eg-title').style.color=myWon?'var(--accent-primary)':'var(--text-secondary)';
          document.getElementById('eg-score').textContent=`${d.s.t0} â€” ${d.s.t1}`;
          Leaderboard.render(document.getElementById('eg-lb'));
          document.getElementById('endgame').classList.remove('hidden');
        }
        if(d.t==='CHAT'){ Effects.toast(`${d.from}: ${d.msg}`, 3000); }
        if(d.t==='PING'){ conn.send({t:'PONG',ts:d.ts}); }
        if(d.t==='PONG'){
          const rtt=Date.now()-Client._pingTs;
          const el=document.getElementById('hud-ping');
          el.style.display='block';
          el.textContent=`${rtt}ms`;
          el.className='hud-ping '+(rtt<80?'ping-good':rtt<150?'ping-ok':'ping-bad');
        }
      });
      conn.on('error',()=>UI.setJoinStatus('âŒ Connexion refusÃ©e'));
    });
    Client.peer.on('error',()=>UI.setJoinStatus('âŒ Erreur rÃ©seau'));
  }
};

// â”€â”€ AI GAME MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AIGame = {
  start(){
    const modeId = document.querySelector('#mode-grid-ai .sel')?.dataset.mode || 'classic';
    AI.diff = S.aiDiff;
    S.role='ai'; S.myTeam=0; S.myIdx=0;
    Game.setup(modeId,[],true);
    UI.showGame();
    document.getElementById('hud').style.display='flex';
    document.getElementById('hud-mode-label').textContent = Game.modeConfig.name.toUpperCase();
    if(Game.modeConfig.timed) document.getElementById('hud-timer').style.display='block';
    ThemeManager.hideToggle();
    Render.init(0);
    Loop.start();
  }
};

// â”€â”€ GAME LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Loop = {
  _raf: null, _last: 0,
  start(){
    this._last = performance.now();
    const tick = (now)=>{
      const dt = Math.min((now-this._last)/16, 3);
      this._last = now;
      if(S.role==='host'||S.role==='ai'){
        Game.update(dt, now);
        if(S.role==='host'){
          const t0n = Game.players.find(p=>p.team===0)?.name||'TEAM';
          const t1n = Game.players.find(p=>p.team===1)?.name||'TEAM';
          Host.broadcast({
            t:'U',
            pk:{x:Math.round(Game.puck.x),y:Math.round(Game.puck.y)},
            pl:Game.players.map(p=>({
              x:Math.round(p.x),
              y:Math.round(p.y),
              color:p.color,
              name:p.name,
              big:p.big,
              frozen:p.frozen,
              ghost:p.ghost
            })),
            s:Game.score,
            puckScale: Game.pups?.mini_puck>0 ? 0.55 : 1,
            pups: PupSystem.list.map(p=>({x:p.x,y:p.y,type:p.type,exp:p.exp,born:p.born})),
            timeLeft: Game.modeConfig.timed ? Game.timeLeft : undefined,
            names: {t0:t0n, t1:t1n}
          });
        }
      }
      Render.draw(now);
      Particles.update();
      this._raf = requestAnimationFrame(tick);
    };
    this._raf = requestAnimationFrame(tick);
  }
};

// â”€â”€ CHAT SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ChatSystem = {
  _open: false,
  toggle(){
    this._open=!this._open;
    document.getElementById('chat-bar').classList.toggle('show',this._open);
  },
  send(i){
    const msg = C.QUICK_CHATS[i];
    Effects.toast(`Vous: ${msg}`, 2500);
    if(S.role==='host') Host.broadcast({t:'CHAT',from:S.myName,msg});
    else if(S.role==='client'&&Client.conn) Client.conn.send({t:'CHAT',msg});
    this.toggle();
  }
};

// â”€â”€ UI MANAGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const UI = {
  init(){
    const grid=document.getElementById('color-grid');
    C.COLORS.forEach((col,i)=>{
      const d=document.createElement('div');
      d.className='c-dot'+(i===0?' sel':'');
      d.style.background=col;
      d.title=C.COLOR_NAMES[i];
      d.onclick=()=>{ 
        document.querySelectorAll('.c-dot').forEach(x=>x.classList.remove('sel')); 
        d.classList.add('sel'); 
        S.myColor=col; 
      };
      grid.appendChild(d);
    });
    document.getElementById('inp-name').addEventListener('input',e=>S.myName=e.target.value||'Joueur');

    ['mode-grid','mode-grid-ai'].forEach(id=>{
      const g=document.getElementById(id);
      if(!g) return;
      C.MODES.forEach((m,i)=>{
        const d=document.createElement('div');
        d.className='mode-card'+(i===0?' sel':'');
        d.dataset.mode=m.id;
        d.innerHTML=`<span class="mode-icon">${m.icon}</span><div class="mode-name">${m.name}</div><div class="mode-desc">${m.desc}</div>`;
        d.onclick=()=>{ 
          g.querySelectorAll('.mode-card').forEach(x=>x.classList.remove('sel')); 
          d.classList.add('sel'); 
          S.myMode=m.id; 
        };
        g.appendChild(d);
      });
    });
  },

  show(id){ 
    document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden')); 
    const screen = document.getElementById(id);
    if(screen) {
      screen.classList.remove('hidden');
    }
  },
  goHome(){ 
    document.getElementById('hud').style.display='none';
    ThemeManager.showToggle();
    this.show('screen-home'); 
  },
  goCreate(){ this.show('screen-create'); },
  goJoin(){ 
    this.show('screen-join'); 
    document.getElementById('join-status').textContent=''; 
    document.getElementById('join-players').style.display='none';
  },
  goAI(){ this.show('screen-ai'); },
  goLeaderboard(){
    Leaderboard.render(document.getElementById('lb-content'));
    this.show('screen-lb');
  },
  showLobby(code){
    this.show('screen-lobby');
    document.getElementById('lobby-code').textContent=code;
  },
  showGame(){ 
    this.show('screen-game'); 
  },
  setJoinStatus(msg){ document.getElementById('join-status').textContent=msg; },
  copyCode(){
    const code=document.getElementById('lobby-code').textContent;
    navigator.clipboard?.writeText(code).then(()=>Effects.toast('ğŸ“‹ Code copiÃ© !')).catch(()=>{});
  },
  selDiff(d){
    S.aiDiff=d;
    document.querySelectorAll('.diff-btn').forEach(b=>b.classList.toggle('sel',parseInt(b.dataset.d)===d));
  }
};

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ThemeManager.init();
Performance.init();
UI.init();

document.getElementById('sel-team').addEventListener('change', function(){
  const btn = document.getElementById('btn-start');
  const modeSize = parseInt(this.value)*2;
  if(modeSize <= 2 && Host.conns.length === 0){
    btn.disabled = false;
    btn.textContent = 'âš¡ LANCER !';
  } else {
    btn.disabled = true;
    btn.textContent = 'â³ En attente de joueursâ€¦';
  }
});
</script>
</body>
</html>
